<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integis Property Assistant</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: transparent;
        }
        
        .chat-container {
            width: 100%;
            height: 100%;
            max-width: 500px;
            max-height: 700px;
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        
        .chat-header {
            background-color: #0078d4;
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: center;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f8f8;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            clear: both;
        }
        
        .user-message {
            background-color: #0078d4;
            color: white;
            float: right;
        }
        
        .bot-message {
            background-color: #e9e9e9;
            color: #333;
            float: left;
        }
        
        .input-container {
            display: flex;
            padding: 15px;
            background-color: #fff;
            border-top: 1px solid #eee;
        }
        
        #user-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 14px;
        }
        
        #send-button {
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 0 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        #send-button:hover {
            background-color: #0069b8;
        }
        
        .property-item {
            margin: 12px 0;
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(0, 120, 212, 0.05);
            border-left: 3px solid #0078d4;
        }
        
        .property-name {
            font-weight: bold;
            color: #0078d4;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .property-details {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .property-detail {
            background-color: #f0f0f0;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }
        
        .typing-indicator {
            background-color: #e9e9e9;
            color: #666;
            padding: 8px 15px;
            border-radius: 18px;
            margin-bottom: 15px;
            display: inline-block;
            float: left;
            clear: both;
        }
        
        /* For iframe embedding, ensure proper sizing */
        @media (max-width: 500px) {
            .chat-container {
                max-width: 100%;
                max-height: 100%;
                height: 100vh;
                border-radius: 0;
                border: none;
            }
        }
        
        /* Clear floats after messages */
        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">Integis Property Assistant</div>
        <div id="messages" class="messages-container"></div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Ask about our properties...">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
        // Initialize properties array
        let properties = [];
        let propertiesLoaded = false;

        // Function to load properties from JSON file
        async function loadProperties() {
            try {
                console.log("Loading properties from JSON file...");
                const loadingMessage = addMessage("Loading property listings...", 'bot');
                
                const response = await fetch('properties.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                properties = await response.json();
                propertiesLoaded = true;
                
                console.log(`Successfully loaded ${properties.length} properties`);
                loadingMessage.innerHTML = `Property listings loaded successfully! I now have information about ${properties.length} properties.`;
                
                return true;
            } catch (error) {
                console.error("Error loading properties:", error);
                const loadingMessage = document.querySelector('.bot-message:last-child');
                if (loadingMessage) {
                    loadingMessage.innerHTML = "I'm having trouble loading the property listings. Please try again later.";
                }
                return false;
            }
        }

        // Hugging Face configuration
        const HUGGING_FACE_TOKEN = "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";
        const MODEL_ID = "meta-llama/Llama-2-7b-hf";

        // Add welcome message and load properties when page loads
        window.addEventListener('load', async function() {
            // Add welcome message
            addMessage("Hello! I'm your Integis property assistant. How can I help you find the perfect commercial property today?", 'bot');
            
            // Load properties
            await loadProperties();
        });

        // Send button click event
        document.getElementById('send-button').addEventListener('click', sendMessage);

        // Enter key press event
        document.getElementById('user-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Function to handle sending messages
        async function sendMessage() {
            const userInput = document.getElementById('user-input');
            if (!userInput.value.trim()) return;
            
            // Add user message
            addMessage(userInput.value, 'user');
            
            // Clear input and store message
            const userMessage = userInput.value;
            userInput.value = '';
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.textContent = 'Typing...';
            typingIndicator.id = 'typing-indicator';
            document.getElementById('messages').appendChild(typingIndicator);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            
            // Ensure properties are loaded
            if (!propertiesLoaded) {
                await loadProperties();
            }
            
            // Get response (using Hugging Face API or fallback)
            try {
                // Try to call Hugging Face API
                const aiResponse = await callHuggingFaceAPI(userMessage);
                if (document.getElementById('typing-indicator')) {
                    document.getElementById('typing-indicator').remove();
                }
                addMessage(aiResponse, 'bot');
            } catch (error) {
                // Fallback to local response if API fails
                console.error("Error calling AI:", error);
                if (document.getElementById('typing-indicator')) {
                    document.getElementById('typing-indicator').remove();
                }
                const fallbackResponse = generateLocalResponse(userMessage);
                addMessage(fallbackResponse, 'bot');
            }
        }

        // Function to add a message to the chat
        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.innerHTML = text;
            
            // Clear any previous messages with the same float direction
            const clearDiv = document.createElement('div');
            clearDiv.className = 'clearfix';
            messagesDiv.appendChild(clearDiv);
            
            messagesDiv.appendChild(messageDiv);
            
            // Another clearfix after the message
            const clearDiv2 = document.createElement('div');
            clearDiv2.className = 'clearfix';
            messagesDiv.appendChild(clearDiv2);
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return messageDiv;
        }

        // Function to call Hugging Face API
        async function callHuggingFaceAPI(userInput) {
            // Check if properties are loaded
            if (!propertiesLoaded || properties.length === 0) {
                return "I don't have access to our property listings at the moment. Please try again later or ask general questions about commercial real estate.";
            }
            
            // Format properties as text for the prompt
            let propertiesText = "";
            properties.forEach(property => {
                let detailsText = `- ${property.name}: ${property.size} sqm ${property.type || ""}`;
                
                if (property.price) {
                    detailsText += `, ${property.price}`;
                }
                
                if (property.floor) {
                    detailsText += `, ${property.floor}`;
                }
                
                // Use location if available, otherwise fallback to city and district
                if (property.location) {
                    detailsText += ` in ${property.location}`;
                } else if (property.city) {
                    detailsText += ` in ${property.city}`;
                    if (property.district) {
                        detailsText += ` - ${property.district}`;
                    }
                }
                
                if (property.available) {
                    detailsText += `, available: ${property.available}`;
                }
                
                detailsText += "\n";
                propertiesText += detailsText;
            });

            // Llama 2 specific prompt formatting
            const prompt = `<s>[INST] <<SYS>>
You are a professional commercial real estate assistant for Integis. Your job is to help clients find the perfect office, retail, or industrial space based on their needs. Be concise, professional, and helpful.

AVAILABLE PROPERTIES:
${propertiesText}
<</SYS>>

${userInput} [/INST]`;

            try {
                console.log("Calling Hugging Face API...");
                
                const response = await fetch(`https://api-inference.huggingface.co/models/${MODEL_ID}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${HUGGING_FACE_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inputs: prompt,
                        parameters: {
                            max_new_tokens: 500,
                            temperature: 0.7,
                            top_p: 0.95,
                            do_sample: true
                        }
                    })
                });

                const result = await response.json();
                console.log("API response received");
                
                // Check for errors or model loading
                if (result.error) {
                    if (result.error.includes("loading")) {
                        return "I'm still warming up. Please try again in a few moments.";
                    }
                    throw new Error(result.error);
                }
                
                // Extract the generated text from response
                if (result && result[0] && result[0].generated_text) {
                    const fullText = result[0].generated_text;
                    // For Llama 2, extract just the response part after the instruction
                    const assistantResponseMatch = fullText.match(/\[\/INST\](.*)/s);
                    const assistantResponse = assistantResponseMatch ? assistantResponseMatch[1].trim() : fullText;
                    return assistantResponse || "I couldn't generate a proper response. Please try again.";
                } else {
                    throw new Error("Unexpected API response format");
                }
            } catch (error) {
                console.error("Error calling Hugging Face API:", error);
                throw error; // Rethrow to trigger fallback
            }
        }

        // Fallback function to generate responses locally (when API fails)
        function generateLocalResponse(userInput) {
            userInput = userInput.toLowerCase();
            
            // Check if properties are loaded
            if (!propertiesLoaded || properties.length === 0) {
                return "I don't have access to our property listings at the moment. Please try again later or contact Integis directly for assistance.";
            }
            
            // Check for greetings
            if (/hello|hi|hey|greetings/i.test(userInput)) {
                return "Hello! How can I help you find the perfect commercial property today?";
            }
            
            // Check for property type queries
            const isOffice = /office|workspace|kanceláře/i.test(userInput);
            const isRetail = /retail|shop|store|obchody/i.test(userInput);
            
            // Check for locations
            const pragueMatch = /prague|praha/i.test(userInput);
            const brnoMatch = /brno/i.test(userInput);
            const ostravaMatch = /ostrava/i.test(userInput);
            
            // Check for district
            let districtMatch = null;
            if (pragueMatch) {
                const pragueDistrictRegex = /prague\s*(\d+)|praha\s*(\d+)/i;
                const match = userInput.match(pragueDistrictRegex);
                if (match && (match[1] || match[2])) {
                    districtMatch = match[1] || match[2];
                }
            }
            
            // Check for size
            const sizeMatches = userInput.match(/(\d+)\s*(?:sq\s*m|sqm|square meter|m2)/i);
            
            // Check for price
            const priceMatches = userInput.match(/(\d+)\s*(?:€|eur|euro|euros|czk|kč)/i);
            
            // Filter properties
            let matchedProperties = [...properties];
            
            if (isOffice) {
                matchedProperties = matchedProperties.filter(p => 
                    p.type && (
                        p.type.toLowerCase().includes('office') || 
                        p.type.toLowerCase().includes('kanceláře')
                    )
                );
            } else if (isRetail) {
                matchedProperties = matchedProperties.filter(p => 
                    p.type && (
                        p.type.toLowerCase().includes('retail') || 
                        p.type.toLowerCase().includes('obchody')
                    )
                );
            }
            
            if (pragueMatch) {
                matchedProperties = matchedProperties.filter(p => 
                    (p.city && p.city.toLowerCase().includes('prague')) || 
                    (p.city && p.city.toLowerCase().includes('praha')) ||
                    (p.location && p.location.toLowerCase().includes('prague')) ||
                    (p.location && p.location.toLowerCase().includes('praha'))
                );
                
                if (districtMatch) {
                    matchedProperties = matchedProperties.filter(p => 
                        (p.district && p.district.includes(districtMatch)) ||
                        (p.location && p.location.includes(districtMatch))
                    );
                }
            } else if (brnoMatch) {
                matchedProperties = matchedProperties.filter(p => 
                    (p.city && p.city.toLowerCase().includes('brno')) ||
                    (p.location && p.location.toLowerCase().includes('brno'))
                );
            } else if (ostravaMatch) {
                matchedProperties = matchedProperties.filter(p => 
                    (p.city && p.city.toLowerCase().includes('ostrava')) ||
                    (p.location && p.location.toLowerCase().includes('ostrava'))
                );
            }
            
            if (sizeMatches) {
                const requestedSize = parseInt(sizeMatches[1]);
                const minSize = requestedSize * 0.5;
                const maxSize = requestedSize * 1.5;
                
                matchedProperties = matchedProperties.filter(p => {
                    const propertySize = parseInt(p.size);
                    return !isNaN(propertySize) && propertySize >= minSize && propertySize <= maxSize;
                });
            }
            
            if (priceMatches) {
                const requestedPrice = parseInt(priceMatches[1]);
                matchedProperties = matchedProperties.filter(p => {
                    if (!p.price) return false;
                    
                    if (p.price.includes('€')) {
                        const priceMatch = p.price.match(/€(\d+)/);
                        if (priceMatch) {
                            const price = parseInt(priceMatch[1]);
                            return Math.abs(price - requestedPrice) <= requestedPrice * 0.3;
                        }
                    } else if (p.price.includes('CZK')) {
                        const priceMatch = p.price.match(/(\d+)\s*CZK/);
                        if (priceMatch) {
                            const price = parseInt(priceMatch[1]);
                            return Math.abs(price - requestedPrice) <= requestedPrice * 0.3;
                        }
                    }
                    
                    return false;
                });
            }
            
            // Generate response with properties
            if (matchedProperties.length > 0) {
                let response = `Based on your query, I found these properties that might interest you:<br><br>`;
                
                // Limit to top 3 properties
                const propertiesToShow = matchedProperties.slice(0, 3);
                
                propertiesToShow.forEach(property => {
                    let propertyDetails = `<div class="property-item">
                        <div class="property-name">${property.name}</div>`;
                    
                    propertyDetails += `<div class="property-details">`;
                    
                    if (property.size) {
                        propertyDetails += `<span class="property-detail">${property.size} sqm</span>`;
                    }
                    
                    if (property.type) {
                        propertyDetails += `<span class="property-detail">${property.type}</span>`;
                    }
                    
                    if (property.price) {
                        propertyDetails += `<span class="property-detail">${property.price}</span>`;
                    }
                    
                    if (property.floor) {
                        propertyDetails += `<span class="property-detail">${property.floor}</span>`;
                    }
                    
                    // Use location if available, otherwise fallback to city and district
                    if (property.location) {
                        propertyDetails += `<span class="property-detail">${property.location}</span>`;
                    } else if (property.city) {
                        let locationText = property.city;
                        if (property.district) {
                            locationText += ` - ${property.district}`;
                        }
                        propertyDetails += `<span class="property-detail">${locationText}</span>`;
                    }
                    
                    if (property.available) {
                        propertyDetails += `<span class="property-detail">Available: ${property.available}</span>`;
                    }
                    
                    propertyDetails += `</div></div>`;
                    
                    response += propertyDetails;
                });
                
                if (matchedProperties.length > 3) {
                    response += `<br>And ${matchedProperties.length - 3} more matching properties.`;
                }
                
                response += `<br>Would you like more details about any of these properties?`;
                return response;
            } else {
                return `I couldn't find exact matches for your criteria from our ${properties.length} properties. Could you try a more general search? For example, you can ask about "office space in Prague" or "retail space around 800 sqm".`;
            }
        }
    </script>
</body>
</html>
