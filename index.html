<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integis Property Assistant</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: transparent;
        }
        
        .chat-container {
            width: 100%;
            height: 100%;
            max-width: 500px;
            max-height: 700px;
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        
        .chat-header {
            background-color: #0078d4;
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: center;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f8f8;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            clear: both;
        }
        
        .user-message {
            background-color: #0078d4;
            color: white;
            float: right;
        }
        
        .bot-message {
            background-color: #e9e9e9;
            color: #333;
            float: left;
        }
        
        .input-container {
            display: flex;
            padding: 15px;
            background-color: #fff;
            border-top: 1px solid #eee;
        }
        
        #user-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 14px;
        }
        
        #send-button {
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 0 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        #send-button:hover {
            background-color: #0069b8;
        }
        
        .property-item {
            margin: 12px 0;
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(0, 120, 212, 0.05);
            border-left: 3px solid #0078d4;
        }
        
        .property-name {
            font-weight: bold;
            color: #0078d4;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .property-details {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .property-detail {
            background-color: #f0f0f0;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }
        
        .typing-indicator {
            background-color: #e9e9e9;
            color: #666;
            padding: 8px 15px;
            border-radius: 18px;
            margin-bottom: 15px;
            display: inline-block;
            float: left;
            clear: both;
        }
        
        /* For iframe embedding, ensure proper sizing */
        @media (max-width: 500px) {
            .chat-container {
                max-width: 100%;
                max-height: 100%;
                height: 100vh;
                border-radius: 0;
                border: none;
            }
        }
        
        /* Clear floats after messages */
        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }
        
        /* Reset button */
        #reset-chat {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 12px;
            opacity: 0.8;
        }
        
        #reset-chat:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            Integis Property Assistant
            <button id="reset-chat">New Chat</button>
        </div>
        <div id="messages" class="messages-container"></div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Ask about our properties...">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
        // Initialize properties array
        let properties = [];
        let propertiesLoaded = false;
        
        // Conversation history - store the entire conversation
        let conversationHistory = [];

        // Function to load properties from JSON file
        async function loadProperties() {
            try {
                console.log("Loading properties from JSON file...");
                const loadingMessage = addMessage("Loading property listings...", 'bot');
                
                const response = await fetch('properties.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                properties = await response.json();
                propertiesLoaded = true;
                
                console.log(`Successfully loaded ${properties.length} properties`);
                loadingMessage.innerHTML = `Property listings loaded successfully! I now have information about ${properties.length} properties.`;
                
                return true;
            } catch (error) {
                console.error("Error loading properties:", error);
                const loadingMessage = document.querySelector('.bot-message:last-child');
                if (loadingMessage) {
                    loadingMessage.innerHTML = "I'm having trouble loading the property listings. Please try again later.";
                }
                return false;
            }
        }

        // Hugging Face configuration
        const HUGGING_FACE_TOKEN = "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";
        const MODEL_ID = "meta-llama/Llama-2-7b-hf";

        // Add welcome message and load properties when page loads
        window.addEventListener('load', async function() {
            // Add welcome message
            const welcomeMessage = "Hello! I'm your Integis property assistant. How can I help you find the perfect commercial property today?";
            addMessage(welcomeMessage, 'bot');
            
            // Add to conversation history
            conversationHistory.push({role: "assistant", content: welcomeMessage});
            
            // Load properties
            await loadProperties();
        });

        // Reset chat button
        document.getElementById('reset-chat').addEventListener('click', function() {
            // Clear conversation history
            conversationHistory = [];
            
            // Clear messages
            document.getElementById('messages').innerHTML = '';
            
            // Add welcome message
            const welcomeMessage = "Hello! I'm your Integis property assistant. How can I help you find the perfect commercial property today?";
            addMessage(welcomeMessage, 'bot');
            
            // Add to conversation history
            conversationHistory.push({role: "assistant", content: welcomeMessage});
        });

        // Send button click event
        document.getElementById('send-button').addEventListener('click', sendMessage);

        // Enter key press event
        document.getElementById('user-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Improved format conversation history function to preserve context better
        function formatConversationHistory() {
            // Get the entire conversation (no arbitrary limits)
            const conversation = conversationHistory.slice();
            
            // Format the conversation history in a way that Llama 2 can understand better
            let formattedHistory = "";
            conversation.forEach((exchange) => {
                if (exchange.role === "user") {
                    formattedHistory += `Human: ${exchange.content}\n`;
                } else {
                    formattedHistory += `Assistant: ${exchange.content}\n`;
                }
            });
            
            return formattedHistory;
        }

        // Enhanced API call function with better prompt engineering
        async function callHuggingFaceAPI(userInput) {
            // Check if properties are loaded
            if (!propertiesLoaded || properties.length === 0) {
                return "I don't have access to our property listings at the moment. Please try again later or ask general questions about commercial real estate.";
            }
            
            // Format properties as text for the prompt - include all properties but in a condensed format
            let propertiesText = "";
            properties.forEach(property => {
                let detailsText = `- ${property.name}: ${property.size} sqm ${property.type || ""}`;
                
                if (property.price) {
                    detailsText += `, ${property.price}`;
                }
                
                if (property.location) {
                    detailsText += ` in ${property.location}`;
                } else if (property.city) {
                    detailsText += ` in ${property.city}`;
                    if (property.district) {
                        detailsText += ` - ${property.district}`;
                    }
                }
                
                if (property.available) {
                    detailsText += `, available: ${property.available}`;
                }
                
                detailsText += "\n";
                propertiesText += detailsText;
            });

            // Get formatted conversation history
            const conversationHistoryText = formatConversationHistory();

            // Create an improved system prompt that better instructs the model
            const systemPrompt = `
You are a professional commercial real estate assistant for Integis. Your job is to help clients find the perfect office, retail, or industrial space based on their needs. Be concise, professional, and helpful.

IMPORTANT INSTRUCTIONS:
1. Always maintain conversation context and remember previous user inquiries
2. If the user asks follow-up questions, refer to properties mentioned earlier
3. When presenting properties, format them in an easy-to-read way
4. If you don't have information, be honest and offer to help in other ways
5. Always respond in the same language as the user (Czech or English)

AVAILABLE PROPERTIES:
${propertiesText}

CONVERSATION HISTORY:
${conversationHistoryText}
`;

            // Llama 2 specific prompt formatting with improved context
            const prompt = `<s>[INST] <<SYS>>
${systemPrompt}
<</SYS>>

${userInput} [/INST]`;

            try {
                console.log("Calling Hugging Face API...");
                
                const response = await fetch(`https://api-inference.huggingface.co/models/${MODEL_ID}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${HUGGING_FACE_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inputs: prompt,
                        parameters: {
                            max_new_tokens: 800,  // Increased for more detailed responses
                            temperature: 0.7,
                            top_p: 0.95,
                            do_sample: true,
                            return_full_text: false  // Only return the generated text, not the prompt
                        }
                    })
                });

                const result = await response.json();
                console.log("API response received:", result);
                
                // Check for errors or model loading
                if (result.error) {
                    if (result.error.includes("loading")) {
                        return "I'm still warming up. Please try again in a few moments.";
                    }
                    throw new Error(result.error);
                }
                
                // Extract the generated text from response with better error handling
                if (result && result[0] && result[0].generated_text) {
                    const fullText = result[0].generated_text;
                    // For Llama 2, extract just the response part
                    const assistantResponseMatch = fullText.match(/\[\/INST\](.*)/s);
                    const assistantResponse = assistantResponseMatch ? assistantResponseMatch[1].trim() : fullText;
                    return assistantResponse || "I couldn't generate a proper response. Please try again.";
                } else {
                    throw new Error("Unexpected API response format");
                }
            } catch (error) {
                console.error("Error calling Hugging Face API:", error);
                throw error; // Rethrow to trigger fallback
            }
        }

        // Enhanced property search function
        function searchProperties(criteria) {
            let results = [...properties];
            
            // Filter by property type
            if (criteria.type) {
                const typeKeywords = criteria.type.toLowerCase().split(/\s+/);
                results = results.filter(p => {
                    if (!p.type) return false;
                    const propertyType = p.type.toLowerCase();
                    return typeKeywords.some(keyword => propertyType.includes(keyword));
                });
            }
            
            // Filter by location (city or district)
            if (criteria.location) {
                const locationKeywords = criteria.location.toLowerCase().split(/\s+/);
                results = results.filter(p => {
                    const propertyLocation = (p.location || "").toLowerCase();
                    const propertyCity = (p.city || "").toLowerCase();
                    const propertyDistrict = (p.district || "").toLowerCase();
                    
                    return locationKeywords.some(keyword => 
                        propertyLocation.includes(keyword) || 
                        propertyCity.includes(keyword) || 
                        propertyDistrict.includes(keyword)
                    );
                });
            }
            
            // Filter by size range (with some flexibility)
            if (criteria.size) {
                const targetSize = parseInt(criteria.size);
                if (!isNaN(targetSize)) {
                    const minSize = targetSize * 0.7;  // 30% below target
                    const maxSize = targetSize * 1.3;  // 30% above target
                    
                    results = results.filter(p => {
                        const propertySize = parseInt(p.size);
                        return !isNaN(propertySize) && propertySize >= minSize && propertySize <= maxSize;
                    });
                }
            }
            
            // Filter by price
            if (criteria.price) {
                // This could be expanded to handle different currency formats and ranges
                results = results.filter(p => {
                    if (!p.price) return false;
                    return p.price.toLowerCase().includes(criteria.price.toLowerCase());
                });
            }
            
            // Filter by availability
            if (criteria.available) {
                const availableKeywords = criteria.available.toLowerCase().split(/\s+/);
                results = results.filter(p => {
                    if (!p.available) return false;
                    const propertyAvailable = p.available.toLowerCase();
                    return availableKeywords.some(keyword => propertyAvailable.includes(keyword));
                });
            }
            
            return results;
        }

        // Enhanced fallback response generator
        function generateLocalResponse(userInput) {
            userInput = userInput.toLowerCase();
            
            // Check if properties are loaded
            if (!propertiesLoaded || properties.length === 0) {
                return "I don't have access to our property listings at the moment. Please try again later or contact Integis directly for assistance.";
            }
            
            // Determine the language based on input (simple heuristic)
            const isCzech = /[áčďéěíňóřšťúůýž]/i.test(userInput);
            
            // Create a search criteria object based on user input
            const criteria = {};
            
            // Check for property type
            if (/office|kancelář/i.test(userInput)) {
                criteria.type = "office";
            } else if (/retail|obchod/i.test(userInput)) {
                criteria.type = "retail";
            } else if (/industrial|průmysl|sklad/i.test(userInput)) {
                criteria.type = "industrial";
            }
            
            // Check for location
            if (/prague|praha/i.test(userInput)) {
                criteria.location = "Prague";
                
                // Check for Prague district
                const pragueDistrictMatch = userInput.match(/prague\s*(\d+)|praha\s*(\d+)/i);
                if (pragueDistrictMatch && (pragueDistrictMatch[1] || pragueDistrictMatch[2])) {
                    criteria.location = `Prague ${pragueDistrictMatch[1] || pragueDistrictMatch[2]}`;
                }
            } else if (/brno/i.test(userInput)) {
                criteria.location = "Brno";
            } else if (/ostrava/i.test(userInput)) {
                criteria.location = "Ostrava";
            }
            
            // Check for size
            const sizeMatch = userInput.match(/(\d+)\s*(?:sq\s*m|sqm|square meter|m2|metr)/i);
            if (sizeMatch) {
                criteria.size = sizeMatch[1];
            }
            
            // Check for price mentions
            if (/€|eur|euro|czk|kč|price|cost|rent|nájem/i.test(userInput)) {
                criteria.price = ""; // Just flag that price is important
            }
            
            // Check for availability mentions
            if (/available|now|immediately|ihned|dostupn/i.test(userInput)) {
                criteria.available = "now";
            } else if (/q[1-4]|quarter|quartal|kvartál|202[0-9]/i.test(userInput)) {
                criteria.available = ""; // Just flag that specific availability is important
            }
            
            // Search for matching properties
            let matchedProperties = searchProperties(criteria);
            
            // Check for follow-up questions about previously mentioned properties
            if (matchedProperties.length === 0 && conversationHistory.length >= 3) {
                const lastBotMessage = conversationHistory.filter(msg => msg.role === "assistant").pop().content;
                
                if (lastBotMessage.includes("properties") || lastBotMessage.includes("property")) {
                    // This might be a follow-up question about previously mentioned properties
                    if (/more|detail|tell|show|yes|please|více|detail|ukaž|ano|prosím/i.test(userInput)) {
                        // Try to extract property names from the last message
                        const propertyRegex = /\b([\w\s]+):\s*\d+\s*sqm/g;
                        let match;
                        const mentionedProperties = [];
                        
                        while ((match = propertyRegex.exec(lastBotMessage)) !== null) {
                            mentionedProperties.push(match[1].trim());
                        }
                        
                        if (mentionedProperties.length > 0) {
                            // Filter properties based on names mentioned in the last message
                            matchedProperties = properties.filter(p => 
                                mentionedProperties.some(name => 
                                    p.name.toLowerCase().includes(name.toLowerCase())
                                )
                            );
                        }
                    }
                }
            }
            
            // Generate response
            if (matchedProperties.length > 0) {
                let response = isCzech 
                    ? `Na základě vašeho dotazu jsem našel tyto nemovitosti, které by vás mohly zajímat:<br><br>`
                    : `Based on your query, I found these properties that might interest you:<br><br>`;
                
                // Limit to top 5 properties
                const propertiesToShow = matchedProperties.slice(0, 5);
                
                propertiesToShow.forEach(property => {
                    let propertyDetails = `<div class="property-item">
                        <div class="property-name">${property.name}</div>`;
                    
                    propertyDetails += `<div class="property-details">`;
                    
                    if (property.size) {
                        propertyDetails += `<span class="property-detail">${property.size} sqm</span>`;
                    }
                    
                    if (property.type) {
                        propertyDetails += `<span class="property-detail">${property.type}</span>`;
                    }
                    
                    if (property.price) {
                        propertyDetails += `<span class="property-detail">${property.price}</span>`;
                    }
                    
                    if (property.floor) {
                        propertyDetails += `<span class="property-detail">${property.floor}</span>`;
                    }
                    
                    // Use location if available, otherwise fallback to city and district
                    if (property.location) {
                        propertyDetails += `<span class="property-detail">${property.location}</span>`;
                    } else if (property.city) {
                        let locationText = property.city;
                        if (property.district) {
                            locationText += ` - ${property.district}`;
                        }
                        propertyDetails += `<span class="property-detail">${locationText}</span>`;
                    }
                    
                    if (property.available) {
                        propertyDetails += `<span class="property-detail">Available: ${property.available}</span>`;
                    }
                    
                    propertyDetails += `</div></div>`;
                    
                    response += propertyDetails;
                });
                
                if (matchedProperties.length > 5) {
                    response += isCzech
                        ? `<br>A dalších ${matchedProperties.length - 5} odpovídajících nemovitostí.`
                        : `<br>And ${matchedProperties.length - 5} more matching properties.`;
                }
                
                response += isCzech
                    ? `<br>Přejete si více informací o některé z těchto nemovitostí?`
                    : `<br>Would you like more details about any of these properties?`;
                    
                return response;
            } else {
                return isCzech
                    ? `Bohužel jsem nenašel přesné shody pro vaše kritéria z našich ${properties.length} nemovitostí. Můžete zkusit obecnější vyhledávání? Například se můžete zeptat na "kancelářské prostory v Praze" nebo "obchodní prostory kolem 800 sqm".`
                    : `I couldn't find exact matches for your criteria from our ${properties.length} properties. Could you try a more general search? For example, you can ask about "office space in Prague" or "retail space around 800 sqm".`;
            }
        }

        // Function to add a message to the chat
        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.innerHTML = text;
            
            // Clear any previous messages with the same float direction
            const clearDiv = document.createElement('div');
            clearDiv.className = 'clearfix';
            messagesDiv.appendChild(clearDiv);
            
            messagesDiv.appendChild(messageDiv);
            
            // Another clearfix after the message
            const clearDiv2 = document.createElement('div');
            clearDiv2.className = 'clearfix';
            messagesDiv.appendChild(clearDiv2);
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return messageDiv;
        }

        // Enhanced function to handle sending messages with better conversation handling
        async function sendMessage() {
            const userInput = document.getElementById('user-input');
            if (!userInput.value.trim()) return;
            
            // Add user message
            addMessage(userInput.value, 'user');
            
            // Add to conversation history
            conversationHistory.push({role: "user", content: userInput.value});
            
            // Clear input and store message
            const userMessage = userInput.value;
            userInput.value = '';
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.textContent = 'Typing...';
            typingIndicator.id = 'typing-indicator';
            document.getElementById('messages').appendChild(typingIndicator);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            
            // Ensure properties are loaded
            if (!propertiesLoaded) {
                await loadProperties();
            }
            
            // Get response (using Hugging Face API or fallback)
            try {
                // Try to call Hugging Face API with timeout for better reliability
                const apiPromise = callHuggingFaceAPI(userMessage);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error("API call timed out")), 30000)
                );
                
                const aiResponse = await Promise.race([apiPromise, timeoutPromise]);
                
                if (document.getElementById('typing-indicator')) {
                    document.getElementById('typing-indicator').remove();
                }
                addMessage(aiResponse, 'bot');
                
                // Add to conversation history
                conversationHistory.push({role: "assistant", content: aiResponse});
            } catch (error) {
                // Fallback to local response if API fails
                console.error("Error calling AI:", error);
                if (document.getElementById('typing-indicator')) {
                    document.getElementById('typing-indicator').remove();
                }
                const fallbackResponse = generateLocalResponse(userMessage);
                addMessage(fallbackResponse, 'bot');
                
                // Add to conversation history
                conversationHistory.push({role: "assistant", content: fallbackResponse});
            }
        }
    </script>
</body>
</html>
