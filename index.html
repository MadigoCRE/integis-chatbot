<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integis Property Assistant</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: transparent;
        }
        
        .chat-container {
            width: 100%;
            height: 100%;
            max-width: 500px;
            max-height: 700px;
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        
        .chat-header {
            background-color: #0078d4;
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: center;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f8f8;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            clear: both;
        }
        
        .user-message {
            background-color: #0078d4;
            color: white;
            float: right;
        }
        
        .bot-message {
            background-color: #e9e9e9;
            color: #333;
            float: left;
        }
        
        .input-container {
            display: flex;
            padding: 15px;
            background-color: #fff;
            border-top: 1px solid #eee;
        }
        
        #user-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 14px;
        }
        
        #send-button {
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 0 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        #send-button:hover {
            background-color: #0069b8;
        }
        
        .property-item {
            margin: 8px 0;
        }
        
        .property-name {
            font-weight: bold;
        }
        
        .typing-indicator {
            background-color: #e9e9e9;
            color: #666;
            padding: 8px 15px;
            border-radius: 18px;
            margin-bottom: 15px;
            display: inline-block;
            float: left;
            clear: both;
        }
        
        /* For iframe embedding, ensure proper sizing */
        @media (max-width: 500px) {
            .chat-container {
                max-width: 100%;
                max-height: 100%;
                height: 100vh;
                border-radius: 0;
                border: none;
            }
        }
        
        /* Clear floats after messages */
        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">Integis Property Assistant</div>
        <div id="messages" class="messages-container"></div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Ask about our properties...">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
        // Initialize empty properties array
        let properties = [];
        let propertiesLoaded = false;

        // Function to fetch properties from your export URL
        async function fetchProperties() {
            try {
                console.log("Fetching properties from export URL...");
                // Try direct URL first
                try {
                    const response = await fetch('https://colliersintegis.eu/czech/_export_units.php', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json, text/plain, */*'
                        },
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        throw new Error("Direct URL failed");
                    }
                    
                    await processResponse(response);
                } catch (directError) {
                    console.log("Direct fetch failed, trying CORS proxy...", directError);
                    
                    // If direct fetch fails, try with CORS proxy
                    const proxyResponse = await fetch('https://api.allorigins.win/raw?url=' + 
                        encodeURIComponent('https://colliersintegis.eu/czech/_export_units.php'));
                    
                    if (!proxyResponse.ok) {
                        throw new Error(`HTTP error! Status: ${proxyResponse.status}`);
                    }
                    
                    await processResponse(proxyResponse);
                }
                
                propertiesLoaded = true;
                console.log(`Successfully loaded ${properties.length} properties`);
            } catch (error) {
                console.error("Error fetching properties:", error);
                addMessage("I'm having trouble loading the property listings. Please try again later or contact Integis directly.", 'bot');
                propertiesLoaded = false;
            }
        }
        
        // Process API response
        async function processResponse(response) {
            let data;
            const contentType = response.headers.get("content-type");
            
            if (contentType && contentType.includes("application/json")) {
                data = await response.json();
            } else {
                // If not JSON, try to parse text as JSON
                const text = await response.text();
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error("Response is not valid JSON:", text.substring(0, 200) + "...");
                    throw new Error("Invalid JSON response");
                }
            }
            
            console.log("Data received, first item:", data && data.length > 0 ? data[0] : "No data");
            
            // Map the data to our property format
            if (Array.isArray(data)) {
                properties = data.map(item => ({
                    name: item.Title || item.building_name || item.title || "Unnamed Property",
                    size: String(item.vacant_office_space || item.vacant_space || item.size || "0"),
                    type: item.unittype || item.type || "space",
                    location: (item.city || "") + (item.district ? " - " + item.district : ""),
                    available: item.available_from || item.availability || "Contact for availability"
                }));
                
                // Log a few properties to verify the format
                if (properties.length > 0) {
                    console.log("Sample properties:", properties.slice(0, 3));
                } else {
                    console.warn("No properties found in data");
                }
            } else {
                console.error("Data is not an array:", data);
                throw new Error("Invalid data format - expected an array");
            }
        }

        // Hugging Face configuration
        const HUGGING_FACE_TOKEN = "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";
        const MODEL_ID = "meta-llama/Llama-2-7b-hf";

        // Add welcome message and fetch properties when page loads
        window.addEventListener('load', async function() {
            // Add welcome message
            addMessage("Hello! I'm your Integis property assistant. How can I help you find the perfect commercial property today?", 'bot');
            
            // Add loading message
            const loadingMessage = addMessage("Loading property listings...", 'bot');
            
            // Fetch properties
            try {
                await fetchProperties();
                // Update or remove loading message
                if (propertiesLoaded) {
                    loadingMessage.innerHTML = `Property listings loaded successfully! I now have information about ${properties.length} properties.`;
                } else {
                    loadingMessage.innerHTML = "I'm having trouble accessing the property listings right now. I'll still try to help with what I know.";
                }
            } catch (error) {
                console.error("Failed to load properties:", error);
                loadingMessage.innerHTML = "I'm having trouble accessing the property listings right now. I'll still try to help with what I know.";
            }
        });

        // Send button click event
        document.getElementById('send-button').addEventListener('click', sendMessage);

        // Enter key press event
        document.getElementById('user-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Function to handle sending messages
        async function sendMessage() {
            const userInput = document.getElementById('user-input');
            if (!userInput.value.trim()) return;
            
            // Add user message
            addMessage(userInput.value, 'user');
            
            // Clear input and store message
            const userMessage = userInput.value;
            userInput.value = '';
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.textContent = 'Typing...';
            typingIndicator.id = 'typing-indicator';
            document.getElementById('messages').appendChild(typingIndicator);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            
            // Check if properties are loaded
            if (!propertiesLoaded || properties.length === 0) {
                // Try to fetch properties again if they're not loaded
                try {
                    await fetchProperties();
                } catch (error) {
                    console.error("Error re-fetching properties:", error);
                }
            }
            
            // Get response (using Hugging Face API or fallback)
            try {
                // Try to call Hugging Face API
                const aiResponse = await callHuggingFaceAPI(userMessage);
                if (document.getElementById('typing-indicator')) {
                    document.getElementById('typing-indicator').remove();
                }
                addMessage(aiResponse, 'bot');
            } catch (error) {
                // Fallback to local response if API fails
                console.error("Error calling AI:", error);
                if (document.getElementById('typing-indicator')) {
                    document.getElementById('typing-indicator').remove();
                }
                const fallbackResponse = generateLocalResponse(userMessage);
                addMessage(fallbackResponse, 'bot');
            }
        }

        // Function to add a message to the chat
        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.innerHTML = text;
            
            // Clear any previous messages with the same float direction
            const clearDiv = document.createElement('div');
            clearDiv.className = 'clearfix';
            messagesDiv.appendChild(clearDiv);
            
            messagesDiv.appendChild(messageDiv);
            
            // Another clearfix after the message
            const clearDiv2 = document.createElement('div');
            clearDiv2.className = 'clearfix';
            messagesDiv.appendChild(clearDiv2);
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return messageDiv;
        }

        // Function to call Hugging Face API
        async function callHuggingFaceAPI(userInput) {
            // Check if properties are loaded
            if (!propertiesLoaded || properties.length === 0) {
                return "I don't have access to our property listings at the moment. Please try again later or ask general questions about commercial real estate.";
            }
            
            // Format properties as text for the prompt
            let propertiesText = "";
            // Limit to 20 properties to avoid token limits
            const propsToInclude = properties.slice(0, 20);
            propsToInclude.forEach(property => {
                propertiesText += `- ${property.name}: ${property.size} sqm ${property.type} in ${property.location}, available: ${property.available}\n`;
            });
            
            if (properties.length > 20) {
                propertiesText += `- Plus ${properties.length - 20} more properties available.\n`;
            }

            // Llama 2 specific prompt formatting
            const prompt = `<s>[INST] <<SYS>>
You are a professional commercial real estate assistant for Integis. Your job is to help clients find the perfect office, retail, or industrial space based on their needs. Be concise, professional, and helpful.

AVAILABLE PROPERTIES:
${propertiesText}
<</SYS>>

${userInput} [/INST]`;

            try {
                console.log("Calling Hugging Face API...");
                
                const response = await fetch(`https://api-inference.huggingface.co/models/${MODEL_ID}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${HUGGING_FACE_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inputs: prompt,
                        parameters: {
                            max_new_tokens: 500,
                            temperature: 0.7,
                            top_p: 0.95,
                            do_sample: true
                        }
                    })
                });

                const result = await response.json();
                console.log("API response received");
                
                // Check for errors or model loading
                if (result.error) {
                    if (result.error.includes("loading")) {
                        return "I'm still warming up. Please try again in a few moments.";
                    }
                    throw new Error(result.error);
                }
                
                // Extract the generated text from response
                if (result && result[0] && result[0].generated_text) {
                    const fullText = result[0].generated_text;
                    // For Llama 2, extract just the response part after the instruction
                    const assistantResponseMatch = fullText.match(/\[\/INST\](.*)/s);
                    const assistantResponse = assistantResponseMatch ? assistantResponseMatch[1].trim() : fullText;
                    return assistantResponse || "I couldn't generate a proper response. Please try again.";
                } else {
                    throw new Error("Unexpected API response format");
                }
            } catch (error) {
                console.error("Error calling Hugging Face API:", error);
                throw error; // Rethrow to trigger fallback
            }
        }

        // Fallback function to generate responses locally (when API fails)
        function generateLocalResponse(userInput) {
            userInput = userInput.toLowerCase();
            
            // Check if properties are loaded
            if (!propertiesLoaded || properties.length === 0) {
                return "I don't have access to our property listings at the moment. Please try again later or contact Integis directly for assistance.";
            }
            
            // Check for greetings
            if (/hello|hi|hey|greetings/i.test(userInput)) {
                return "Hello! How can I help you find the perfect commercial property today?";
            }
            
            // Check for property type queries
            const isOffice = /office|workspace/i.test(userInput);
            const isRetail = /retail|shop|store/i.test(userInput);
            
            // Check for locations
            const locationMatches = userInput.match(/prague\s*(\d+|center|downtown)?/i);
            
            // Check for size
            const sizeMatches = userInput.match(/(\d+)\s*(?:sq\s*m|sqm|square meter|m2)/i);
            
            // Filter properties
            let matchedProperties = [...properties];
            
            if (isOffice) {
                matchedProperties = matchedProperties.filter(p => p.type.toLowerCase().includes('office'));
            } else if (isRetail) {
                matchedProperties = matchedProperties.filter(p => p.type.toLowerCase().includes('retail'));
            }
            
            if (locationMatches) {
                const location = locationMatches[0].toLowerCase();
                matchedProperties = matchedProperties.filter(p => p.location.toLowerCase().includes(location));
            }
            
            if (sizeMatches) {
                const requestedSize = parseInt(sizeMatches[1]);
                const minSize = requestedSize * 0.5;
                const maxSize = requestedSize * 1.5;
                
                matchedProperties = matchedProperties.filter(p => {
                    const propertySize = parseInt(p.size);
                    return !isNaN(propertySize) && propertySize >= minSize && propertySize <= maxSize;
                });
            }
            
            // Generate response with properties
            if (matchedProperties.length > 0) {
                let response = `Based on your query, I found these properties that might interest you:<br><br>`;
                
                // Limit to top 3 properties
                const propertiesToShow = matchedProperties.slice(0, 3);
                
                propertiesToShow.forEach(property => {
                    response += `<div class="property-item">
                        <span class="property-name">${property.name}</span> - ${property.size} sqm ${property.type} in ${property.location}, available: ${property.available}
                    </div>`;
                });
                
                if (matchedProperties.length > 3) {
                    response += `<br>And ${matchedProperties.length - 3} more matching properties.`;
                }
                
                response += `<br>Would you like more details about any of these properties?`;
                return response;
            } else {
                return `I couldn't find exact matches for your criteria from our ${properties.length} properties. Could you try a more general search? For example, you can ask about "office space in Prague" or "retail space around 800 sqm".`;
            }
        }
    </script>
</body>
</html>
